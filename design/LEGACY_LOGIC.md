---
tags:
  - layer/data
  - legacy/gosling1
  - status/approved
links:
  - design/ID3_ANALYSIS.md
  - design/tasks.md
---

# Legacy Logic: Gosling 1 Behavior & Rules

This document outlines the specific business logic, file handling rules, and text processing behaviors extracted from the legacy Java application (`Gosling v1`). 

**Goal:** Ensure `Gosling v2` maintains 1:1 compatibility with the legacy data structure and workflow where required.

---

## 1. üìÇ File System Logic

The legacy application enforces a strict directory hierarchy for organizing MP3 files.

### 1.1. Path Structure
**Pattern:** `Z:\Songs\<GENRE>[\<YEAR>]\<ARTIST> - <TITLE>.mp3`

### 1.2. Genre Folder Mapping
Some genres map to specific folder names or have special routing rules:

| ID3 Genre | Folder Name | Note |
| :--- | :--- | :--- |
| `pop` | `""` (Empty String) | **Default Behavior**: Files go into `Z:\Songs\[<YEAR>]\` directly. |
| `domoljubne` | `cro\domoljubne` | Nested path override. |
| `acoustic` | `akustika` | Translation override. |
| `club` | `clubbing` | Renaming override. |

### 1.3. Year Folder Exception
By default, files are placed in a `\<YEAR>\` subfolder. However, the following genres use a **Flat Structure** (No Year Folder):

> `religiozne`, `oldies`, `x-mas`, `cro\domoljubne`, `country`, `slow`, `metal`, `navijacke`, `rock`, `jazz`, `dance`, `trance`, `electronic`, `acoustic`, `funk`, `blues`

### 1.4. Filename Sanitization
Filenames are constructed as `<ARTIST> - <TITLE>.mp3`.
*   **Construction Rule**: `<ARTIST>` is generated by joining all **Performer** names from the database (e.g., `["Bob", "Rob"]` becomes `"Bob, Rob"`).
To comply with **Windows Filesystem Restrictions**, illegal characters must be replaced with `_`.
*   **Primary Offenders (from Legacy Audit):**
    *   `:` replaced with `_`
    *   `/` replaced with `_`
*   **General Rule**: Any character that breaks the filesystem (e.g., `?`, `*`, `|`, `<`, `>`, `"`, `\`) should inherently be treated similarly if encountered.

---

## 2. üìù Metadata & ID3 Logic

### 2.1. The "Done" Flag Protocol

#### A. Legacy Protocol (Gosling 1)
The legacy automation relies on the **Initial Key (`TKEY`)** frame.
*   **Requirement**: Gosling 2 MUST write these exact values to maintain compatibility.

| State | TKEY Value |
| :--- | :--- |
| **Not Done** | `" "` (Single Space) |
| **Done** | `"true"` |

#### B. Gosling 2 Implementation
*   **Status**: ‚úÖ **Implemented** (in `MetadataService`).
*   **Strategy**: **Dual Mode**. We write both the Legacy TKEY and a modern standard tag.
    1.  **TKEY**: Writes `"true"` or `" "` (as per Legacy Protocol).
    2.  **TXXX:GOSLING_DONE**: Writes `"1"` or `"0"` for robust future-proofing.

### 2.2. Missing Fields (Parity Gap)
The following fields are strictly used in Gosling 1 but are currently missing in the Gosling 2 `Yellberus` registry:
*   **Album** (`TALB`)
*   **Publisher** (`TPUB`)
*   **Genre** (`TCON`) - *Used for folder routing*

### 2.3. Automatic Text Cleaning (On Save)
The legacy app performed destructive edits to standardize filenames.

#### A. Feature Standardization (Legacy: `Title (ft X)` -> `Artist ft X`)
*   **Gosling 2 Strategy**: **REPLACE** with Relational Parsing.
    *   Instead of moving text strings, we parse `(ft X)` / `(With X)` and add `X` as a distinct **Performer** in the database.
    *   This preserves the data atomically without creating long, messy Artist strings.

#### B. Instrumental Tagging (Legacy: `(i)` -> `(Instrumental)`)
*   **Legacy Logic**: If Genre is "Instrumental" AND Title ends in `(i)`, expand to `(Instrumental)`.
*   **Gosling 2 Strategy**: **RETAIN** for Version Disambiguation.
    *   **Rule**: The `(Instrumental)` tag is needed **ONLY** when both a vocal and instrumental version of the same song exist.
        *   Pure instrumentals (Vivaldi, Sandstorm) require **no tag**.
        *   If "Besame Mucho" (vocal) AND "Besame Mucho" (instrumental) both exist, the instrumental **MUST** have `(Instrumental)` appended.
    *   **Trigger**: On Save, the system should detect potential filename collisions and prompt/enforce the tag.

### 2.4. Duplicate Detection (On Import)
When a new file is added to the library, the system should check for existing duplicates.

*   **Detection Priority (Tiered):**
    1.  **ISRC Match**: If the incoming file has an ISRC, check for existing songs with the same ISRC. **Definitive match.**
    2.  **File Hash Match**: If ISRC is absent, compute MD5/SHA hash and compare. **Definitive for identical bitstreams.**
    3.  **Metadata Match**: Fallback check on `Genre + Year + Artist + Title`. **Fastest, but may have false positives** (e.g., different genre for same song).
*   **On Duplicate Detected**: Warn the user and let them decide (Keep Existing / Replace / Keep Both).
*   **Note**: Songs don't always have ISRCs, and different quality versions will have different hashes. The metadata fallback is a "best effort."

---

## 3. üî° String Sanitization Rules

The application enforces strict character replacement to ensure file system compatibility and standard casing.

### 3.1. The "Anti-Cro" Character Map (‚ö†Ô∏è DEPRECATED / FALLBACK ONLY)
*   **Legacy Behavior**: Aggressively replaced Croatian characters to ensure ASCII compatibility (`ƒë` -> `dj`, `≈°` -> `s`, etc.).
*   **Gosling 2 Strategy**: **Preserve Native Characters (UTF-8).**
    *   We assume the filesystem and network share handle standard UTF-8 correctly.
    *   **Verification**: Use `tools/check_legacy_db_encoding.py` to confirm MS Access compatibility.
    *   **The map below is retained ONLY as a fallback** if we discover actual crashes.

**(Reference Only)**
| Source | Replacement | Source | Replacement |
| :--- | :--- | :--- | :--- |
| `ƒá`, `ƒç` | `c` | `≈°` | `s` |
| `≈æ` | `z` | `ƒë` | **`dj`** |
| `√±` | `n` | `√∏` | `o` |
| `√ü` | `ss` | `√¶` | `ae` |

> **Final Polish (Legacy Only, Not Implemented)**: Any remaining character with ASCII value > 127 was replaced with `%%`.

### 3.2. Casing Rules (CamelCase)
*   **Legacy Behavior**: Enforced "Title Case" logic (capitalize after space, dot, etc.).
*   **Gosling 2 Strategy**: **DEPRECATED / REMOVED.**
    *   **Reason**: Modern artist styling varies wildy (e.g., `will.i.am`). Auto-casing is often incorrect.
    *   **Solution**: We respect the exact casing stored in the `Contributors` table. If a name is wrong, it should be fixed **once** in the Person/Contributor entry, not auto-corrected per file.

### 3.3. Composer Formatting (Spotify Paste Helper)
*   **Legacy Behavior**: Automatically split "CamelCase" names (`LastnameFirstname` -> `Lastname Firstname`) to fix copy-paste errors from Spotify.
*   **Gosling 2 Strategy**: **Migrate to UI Feature (Smart Paste).**
    *   This logic should **NOT** run silently in the backend.
    *   **Future Feature**: When pasting text into the "Composers" input field in the Metadata Editor, the UI should offer to parse/split the string and suggest matching Contributors.
    *   **Action**: Deferred. See **Task T-18 (Smart Paste)** in `tasks.md`.

---

## 4. üõ†Ô∏è Clean Path vs. Legacy Debt (The Gosling 2 Strategy)

Based on the audit and user feedback, Gosling 2 will transition away from "Monolith Hacks" while maintaining compatibility.

### 4.1. Relational Artists (Replacing the 'ft.' Hack)
*   **Legacy**: Destructively merged `Title (ft X)` into a single `Artist` string.
*   **Gosling 2**: Will use a parser to identify features and add them as separate rows in the `MediaSourceContributorRoles` table. Data stays atomic and searchable.

### 4.2. Encoding over Sanitization
*   **Legacy**: Nuked non-ASCII characters to `%%` for fail-safe transfer.
*   **Gosling 2 Strategy**: **Target UTF-8 (Subject to Verification).**
    *   We aim to use standard UTF-8. The `%%` replacement is deprecated.
    *   **Caveat**: This assumption **MUST** be verified against the actual `MDB`/`ACCDB` file using `tools/check_legacy_db_encoding.py` before final deployment.

### 4.3. Mandatory Routing (The "Boss" Factor)
*   **Constraint**: The legacy automation system and existing user workflows rely on specific folder structures (e.g., `Z:\Songs\Genre\Year`).
*   **Gosling 2 Strategy**: Implement Legacy Routing, but **Externalize Rules**.
    *   **Implementation**: Move the "No-Year" list and "Folder Maps" to a JSON configuration file (e.g., `config/legacy_routing.json`).
    *   **Benefit**: Allows adding new rules without touching code.
    *   **End Game**: This entire feature is technically **Redundant/Legacy Debt** and should be removed once/if the organization fully switches to Gosling 2's database-first approach.

### 4.4. Encoding & MS Access
*   **Constraint**: Legacy systems (MS Access, RadioStar) likely use `Windows-1250`/`1252`.
*   **Gosling 2 Strategy**: Rely on standard Python UTF-8 and `os.fsdecode`. We treat filenames as the source of truth on disk.
*   **Verification Tool**: `tools/check_legacy_db_encoding.py` validates MS Access compatibility.
*   **Note**: This section is complementary to Section 4.2. Both MUST be verified before deployment.

---

## 5. üöÄ Implementation Checklist for Gosling 2
To achieve Task **T-06 (Legacy Sync)**:

1.  [ ] **Schema Update**: Add `album`, `publisher`, `genre` to `Yellberus` and Database.
    *   *Prerequisite*: Finish T-04 (Test Consolidation).
2.  [x] **Legacy Writer**: `TKEY` logic ("True" / " ") is **Implemented** in `MetadataService`.
3.  [ ] **Auto-Renamer**: Port the `generateNewFilename` logic to Python (including the Genre/Year folder rules).
4.  [ ] **Duplicate Detection**: Implement tiered check (ISRC ‚Üí Hash ‚Üí Metadata) on Import.
5.  [ ] **Smart Input (Future)**: Implement "Spotify De-Mangler" in the Metadata Editor UI (Post-MVP).
